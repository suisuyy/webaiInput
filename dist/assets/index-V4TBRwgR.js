(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();const a={config:{corsproxy_url:["https://corsp.suisuy.eu.org?"],lepton_api:{llm_models:{wizardlm8x22b:{url:"https://wizardlm-2-8x22b.lepton.run/api/v1/chat/completions",name:"wizardlm-2-8x22b"},mixtral:{url:"https://mixtral-8x7b.lepton.run/api/v1/chat/completions",name:"mixtral-8x7b"}},api_token:["jl9xg3km3plgxmtk835jvjmzra3x2qzf"]},zIndex:{highest:999999,higher:99999,high:9999,medium:999},apiKey:{flowgpt:""}},Recorder:class{constructor(e){this.apiKey=e,this.isRecording=!1,this.mediaRecorder,this.encodeType="audio/mpeg",this.language="en",this.recordingColor="lightblue"}async startRecording(e,t=()=>{console.log("silence detect")},r=!0){return this.stopRecording(),console.log("start recording"),navigator.mediaDevices.getUserMedia({audio:!0}).then(n=>{this.mediaRecorder=new MediaRecorder(n);let o=Date.now(),s=0,u=this.mediaRecorder,d=[];u.start(),this.isRecording=!0,e.style.backgroundColor="rgba(173, 216, 230, 0.3)";let p,c;c=new AudioContext;const C=c.createAnalyser();c.createMediaStreamSource(u.stream).connect(C),C.fftSize=512;const x=C.frequencyBinCount,m=new Uint8Array(x);return p=setInterval(()=>{C.getByteFrequencyData(m);let w=0;for(let g=0;g<x;g++)w+=m[g];let v=w/x;v<10?(s=Date.now()-o,s>1e3&&t()):o=Date.now();let R=3+v/15;e.style.transform=`scale(${R})`},100),u.addEventListener("dataavailable",w=>{console.log("dataavailable"),d.push(w.data)}),new Promise((w,v)=>{u.addEventListener("stop",async()=>{this.isRecording=!1,console.log("stop"),clearInterval(p);const R=new Blob(d,{type:this.encodeType});e.style.transform="scale(1)",e.style.background="transparent",c==null||c.close(),u.stream.getTracks().forEach(g=>g.stop()),console.log("resolved "),w(R)})})}).catch(n=>{n.name==="PermissionDeniedError"||n.name==="NotAllowedError"?(console.error("User denied permission to access audio"),showNotification("Audio permission denied")):(console.error("An error occurred while accessing the audio device",n),showNotification("Error accessing audio device"))})}async startRecordingWithSilenceDetection(e,t=()=>{console.log("silence detect")},r=!0){return r=S.autoStop||r,this.stopRecording(),console.log("start recording"),navigator.mediaDevices.getUserMedia({audio:!0}).then(n=>{this.mediaRecorder=new MediaRecorder(n);let o=Date.now(),s=!1,u=!0,d=Date.now(),p=0,c=this.mediaRecorder,C=[];c.start(),this.isRecording=!0,e.style.backgroundColor="rgba(173, 216, 230, 0.3)";let T,x;x=new AudioContext;const m=x.createAnalyser();x.createMediaStreamSource(c.stream).connect(m),m.fftSize=512;const w=m.frequencyBinCount,v=new Uint8Array(w);T=setInterval(()=>{m.getByteFrequencyData(v);let h=0;for(let B=0;B<w;B++)h+=v[B];let k=h/w;k<15?s?(p=Date.now()-d,p>3e3&&(u=!0,c.requestData(),d=Date.now())):(p=Date.now()-d,p>1e3&&(s=!0,console.log("change isSilent to true"),c.requestData())):(s=!1,u=!1,d=Date.now());let L=3+k/15;e.style.transform=`scale(${L})`},100);let g=0,E;return setTimeout(()=>{c.requestData()},200),c.addEventListener("dataavailable",h=>{if(r===!0&&Date.now()-o>6e5&&c.stop(),g++,g<=1){E=h.data,h.data.size>0&&C.push(h.data);return}if(console.log("dataavailable",h.data),u){console.log("dataavailable,Long silent will do noting",h.data);return}t(new Blob([E,h.data],{type:c.mimeType}))}),new Promise((h,k)=>{c.addEventListener("stop",async()=>{this.isRecording=!1,console.log("stop"),clearInterval(T);const L=new Blob(C,{type:this.encodeType});e.style.transform="scale(1)",e.style.background="transparent",x==null||x.close(),c.stream.getTracks().forEach(B=>B.stop()),console.log("resolved "),h(L)})})}).catch(n=>{n.name==="PermissionDeniedError"||n.name==="NotAllowedError"?(console.error("User denied permission to access audio"),showNotification("Audio permission denied")):(console.error("An error occurred while accessing the audio device",n),showNotification("Error accessing audio device"))})}stopRecording(){var e,t,r,n,o;this.isRecording=!1,(e=this.mediaRecorder)==null||e.stop(),(r=(t=this.mediaRecorder)==null?void 0:t.audioContext)==null||r.close(),(o=(n=this.mediaRecorder)==null?void 0:n.stream)==null||o.getTracks().forEach(s=>s.stop())}},tts:function(e="test text",t="alloy"){if(e&&t){let r=`https://tts.grapee.ddnsfree.com/tts/${encodeURIComponent(e)}`,n=document.getElementById("devlent_tts_container");n||(n=document.createElement("div"),n.id="devlent_tts_container",document.body.appendChild(n));let o=document.getElementById("tts_audio");if(!o){o=document.createElement("audio"),o.id="tts_audio",n.appendChild(o);let s=document.createElement("button");s.innerHTML="Hide Audio",s.onclick=function(){n.style.display="none"},n.appendChild(s)}n.style.display="block",n.style.position="fixed",n.style.top="0",n.style.right="0",o.src=r,o.controls=!0,o.autoplay=!0}},sendAudioToLeptonWhisperApi:async function(e,t,r){try{let n=a.showToast;n("transcribing"),r=r||"data:audio/mpeg;base64,";const o=await fetch("https://corsp.suisuy.eu.org/?https://whisperx.lepton.run/run",{method:"POST",headers:{Authorization:"Bearer jl9xg3km3plgxmtk835jvjmzra3x2qzf","Content-Type":"application/json"},body:JSON.stringify({input:r+await a.blobToBase64(e),language:t||""})});if(!o.ok)return console.log(o),n("transcribe error: "+o.statusText),!1;const s=await o.json();return console.log(s),s[0]?s[0]:(n("transcribe error: "+JSON.stringify(s)),!1)}catch(n){return console.log(n),!1}},modalWhisper:async function(l,e,t){try{let r=a.showToast;r("transcribing by modal whipser"),t=t||"data:audio/mpeg;base64,";const n=await fetch("https://aiapidev.suisuy.eu.org/transcribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({audio:t+await a.blobToBase64(l),diarize_audio:!1})});if(!n.ok)return console.log(n),r("transcribe error: "+n.statusText),!1;const o=await n.json();return console.log(o),o.text?o:(r("transcribe error: "+JSON.stringify(o)),!1)}catch(r){return console.log(r),!1}},stt:async l=>await a.modalWhisper(l),checkValidString(l){return!(l==null||l.trim()===""||l==="undefined"||l==="null")},isEditableElement:function(e){for(;e;){if(e.contentEditable==="true")return!0;e=e.parentElement}return!1},disableSelect:function(e){e.style.userSelect="none",e.addEventListener("pointerdown",t=>{t.preventDefault()})},getSelectionText:function(){let e=document.activeElement;return e&&e.value?e.value.substring(e.selectionStart,e.selectionEnd):window.getSelection().toString()},makeButtonFeedback:function(e){let t=e.style.backgroundColor||"white";e.addEventListener("pointerdown",function(){e.style.backgroundColor="lightblue"}),e.addEventListener("pointerup",function(){setTimeout(()=>{e.style.backgroundColor=t},1e3)}),e.addEventListener("pointercancel",function(){setTimeout(()=>{e.style.backgroundColor=t},1e3)})},showToast:function(e,t=0,r=0,n=200,o=0,s=1e3,u=9999){const d=document.createElement("textarea");d.value=e,d.style.width=n+"px",d.style.height=o===0?"auto":o+"px",d.style.borderWidth="0",d.style.outline="none",d.style.position="fixed",d.style.left=t+"px",d.style.top=r+"px",d.style.zIndex=u,d.disabled=!0,document.body.appendChild(d),setTimeout(()=>{document.body.removeChild(d)},s)},copyToClipboard:function(e){const t=document.createElement("textarea");t.value=e,t.style.width="50%",t.style.height="100px",t.style.borderWidth="0",t.style.outline="none",t.style.position="fixed",t.style.left="0",t.style.top="0",t.style.zIndex="9999999",document.body.appendChild(t),t.select(),document.execCommand("copy"),t.disabled=!0,t.value=`copyed to clipboard 
`+t.value,t.scrollTo(1e4,1e5),setTimeout(()=>{document.body.removeChild(t)},4e3)},writeText:function(e,t,r=" ",n=" "){console.log("writeText(): ",e),document.execCommand("insertText",!1,`${r}${t}${n}`)||a.copyToClipboard(t)},dragElement:function(e,t=e.parentElement,r=3){e.style.touchAction="none";let n=0,o=0,s;e.addEventListener("pointerdown",c=>{u(c)});function u(c){c=c||window.event,c.preventDefault(),n=c.clientX,o=c.clientY,document.body.addEventListener("pointermove",d),document.body.addEventListener("pointerup",p),s=document.querySelector("#shadeDivForDragElement")||document.createElement("div"),s.id="shadeDivForDragElement",s.style.width="300vw",s.style.height="300vh",s.style.position="fixed",s.style.top="0",s.style.left="0",s.style.backgroundColor="rgb(230,230,230,0.2)",s.style.zIndex=1e5,document.body.appendChild(s),setTimeout(()=>{document.body.removeChild(document.querySelector("#shadeDivForDragElement"))},1e4)}function d(c){c=c||window.event,c.preventDefault(),n-c.clientX,o-c.clientY,t.style.position="fixed",t.style.top=c.clientY-e.clientHeight/2+"px",t.style.left=c.clientX-e.clientWidth/2+"px"}function p(){console.log("closeDragElement(): pointerup"),document.body.removeEventListener("pointermove",d),document.body.removeEventListener("pointerup",p),document.body.removeChild(document.querySelector("#shadeDivForDragElement"))}},renderMarkdown(l,e){let t=/^(#{1,6})\s*(.*)$/gm;const r=/\*\*(.*?)\*\*/g,n=/\[(.*?)\]\((.*?)\)/g,o=/(?:\n)/g,s=/`(.*?)`/g,u=/```(\w+)?\n(.*?)```/gs;let d=l,p=d.split("```");for(let i=0;i<p.length;i++)i%2===0&&(p[i]=p[i].replace(t,(z,D,F)=>{const $=D.length;return`<h${$}>${F}</h${$}>`}),p[i]=p[i].replace(o,(z,D,F)=>(D.length,"<br>")));d=p.join("```"),d=d.replace(r,"<strong>$1</strong>"),d=d.replace(n,'<a href="$2">$1</a>'),d=d.replace(u,(i,z,D)=>`
          <div class="code-block">
              <button class="copy-code-btn">Copy</button>
              <button class="insert-code-btn">Insert</button>
              <pre id='devilentCodePre'>
              <xmp>${D}</xmp>
              </pre>
          </div>
      `),d=d.replace(s,"<code>$1</code>"),e.innerHTML=d,e.querySelectorAll(".code-block button").forEach(i=>{i.addEventListener("pointerdown",z=>{z.preventDefault();const D=i.parentElement.querySelector("pre").innerText;i.classList.contains("copy-code-btn")?a.copyToClipboard(D):i.classList.contains("insert-code-btn")&&(console.log("insert button down"),a.writeText(document.activeElement,D,"",""))})});const C=document.createElement("button");C.innerText="Copy",C.addEventListener("pointerdown",i=>{i.preventDefault(),i.stopPropagation(),a.copyToClipboard(l)});const T=document.createElement("button");T.innerText="Insert",T.addEventListener("pointerdown",i=>{i.preventDefault(),i.stopPropagation(),a.writeText(document.activeElement,l,"","")}),C.classList.add("copy-btn"),T.classList.add("insert-btn");let x=document.createElement("button");x.innerText="Edit",x.addEventListener("pointerdown",i=>{i.preventDefault(),e.isEditableElement?e.setAttribute("contenteditable","false"):e.setAttribute("contenteditable","true")}),x.classList.add("copy-btn");const m=document.createElement("button");m.innerText="Close",m.addEventListener("pointerdown",i=>{i.preventDefault(),e.remove()}),m.classList.add("copy-btn");let y=document.createElement("div");y.classList.add("button-container"),y.appendChild(C),y.appendChild(T),y.appendChild(m),y.appendChild(x);const w=e;y.style.width="100%",y.style.backgroundColor=w.style.backgroundColor,y.style.color="lighten("+y.style.backgroundColor+", 20%)",e.prepend(y),a.dragElement(y,e),e.classList.add("markdown-container");let v=document.getElementsByClassName("markdown-container");for(let i=0;i<v.length;i++)v[i].style.fontFamily="Arial, sans-serif",v[i].style.lineHeight="1.6",v[i].style.maxWidth="800px",v[i].style.margin="0 auto",v[i].style.padding="0px",v[i].style.backgroundColor="azure",v[i].style.overflow="auto",v[i].style.boxShadow="0px 0px 50px rgba(0, 0, 0, 0.4)";let R=document.getElementsByClassName("code-block");for(let i=0;i<R.length;i++)R[i].style.position="relative";let g=document.getElementsByClassName("insert-code-btn"),E=document.getElementsByClassName("copy-code-btn");for(let i=0;i<E.length;i++)E[i].style.top="0",E[i].style.position="absolute",E[i].style.right="0",E[i].style.margin="5px",E[i].style.padding="2px 5px",E[i].style.fontSize="12px",E[i].style.border="none",E[i].style.borderRadius="3px",E[i].style.backgroundColor="#007bff",E[i].style.color="white",E[i].style.cursor="pointer";for(let i=0;i<g.length;i++)g[i].style.position="absolute",g[i].style.top="0",g[i].style.right="50px",g[i].style.margin="5px",g[i].style.padding="2px 5px",g[i].style.fontSize="12px",g[i].style.border="none",g[i].style.borderRadius="3px",g[i].style.backgroundColor="#007bff",g[i].style.color="white",g[i].style.cursor="pointer";let h=document.getElementsByClassName("copy-btn"),k=document.getElementsByClassName("insert-btn");for(let i=0;i<h.length;i++)h[i].style.margin="5px",h[i].style.padding="2px 5px",h[i].style.fontSize="12px",h[i].style.border="none",h[i].style.borderRadius="3px",h[i].style.backgroundColor="#007bff",h[i].style.color="white",h[i].style.cursor="pointer";for(let i=0;i<k.length;i++)k[i].style.margin="5px",k[i].style.padding="2px 5px",k[i].style.fontSize="12px",k[i].style.border="none",k[i].style.borderRadius="3px",k[i].style.backgroundColor="#007bff",k[i].style.color="white",k[i].style.cursor="pointer";let L=e.getElementsByTagName("pre");for(let i=0;i<L.length;i++)L[i].style.backgroundColor="#f7f7f7",L[i].style.borderRadius="5px",L[i].style.padding="10px",L[i].style.whiteSpace="pre-wrap",L[i].style.wordBreak="break-all";let B=e.getElementsByTagName("code");for(let i=0;i<B.length;i++)B[i].style.backgroundColor="#f1f1f1",B[i].style.borderRadius="3px",B[i].style.padding="2px 5px",B[i].style.fontFamily="'Courier New', Courier, monospace"},displayMarkdown(l){let e="ai_input_md_dispalyer",t=document.getElementById(e);t===null&&(t=document.getElementById(e)||document.createElement("div"),t.id=e,document.body.appendChild(t),t.style.zIndex="100000",t.style.position="fixed",t.style.bottom="0",t.style.left="0",t.style.height="40vh",t.style.width="80vw",t.style.backgroundColor="rgba{20,20,50,1}"),a.renderMarkdown(l,t)},moveElementNearMouse:(l,e,t=!0,r)=>{let n=r.clientX+200,o=r.clientY-20;console.log("moveElementNearMouse: ",n,o),t&&(n=Math.abs(n),o=Math.abs(o),n=Math.min(n,window.innerWidth-l.clientWidth),o=Math.min(o,window.innerHeight-10-l.clientHeight)),l.style.left=n+"px",l.style.top=o+"px"},addEventListenerForActualClick(l,e){let t,r,n;l.addEventListener("pointerdown",o=>{t=o.clientX,r=o.clientY,n=Date.now()}),l.addEventListener("pointerup",o=>{const s=Math.abs(o.clientX-t),u=Math.abs(o.clientY-r);s<=10&&u<=10&&Date.now()-n<1e3&&(console.log("Minimal mouse movement (< 10px in either direction) and short duration click detected."),e(o))})},sendKeyEvent(l,e,t){const r=new KeyboardEvent("keydown",{key:e,code:e.toUpperCase(),bubbles:!0,cancelable:!0,...t}),n=new KeyboardEvent("keyup",{key:e,code:e.toUpperCase(),bubbles:!0,cancelable:!0,...t});l.dispatchEvent(r),l.dispatchEvent(n)},blobToBase64:function(e){if(!(e instanceof Blob))throw new TypeError("Parameter must be a Blob object.");if(!e.size)throw new Error("Empty Blob provided.");return new Promise((t,r)=>{const n=new FileReader;n.onload=()=>t(n.result.split(",")[1]),n.onerror=r,n.readAsDataURL(e)})},playAudioBlob:function(e,t=!0){const r=new Audio;r.src=URL.createObjectURL(e),r.controls=!0,document.body.prepend(r),t===!0&&r.play().then(()=>{console.log("Audio played successfully!")}).catch(n=>{console.error("Error playing audio:",n)})},async leptonSimpleComplete(l){var n,o;if(console.log("leptonSimpleComlete(): ",l),a.checkValidString(l)===!1)return;let e=await fetch(a.config.corsproxy_url+S.llm_model.url+`?reqtime=${Date.now()}`,{headers:{accept:"*/*","content-type":"application/json",Authorization:`Bearer ${a.config.lepton_api.api_token[0]}`},body:JSON.stringify({messages:[{role:"user",content:l}],model:S.llm_model.name,tools:[],temperature:.7,top_p:.8,max_tokens:1e5}),method:"POST"});e=await e.json();let t=(o=(n=e==null?void 0:e.choices[0])==null?void 0:n.message)==null?void 0:o.content;console.log("[leptonComplete(text)]",t);let r=document.createElement("div");return document.body.appendChild(r),a.displayMarkdown(l+`

`+S.llm_model.name+`
`+t),e}};window.devilentLIBS=a;let S={api_url:"",api_key:"",voice_button_id:"whisper_voice_button",transcribeProvider:"lepton_whisper",language:"",supportedInputTypeList:["text","number","tel","search","url","email"],buttonBackgroundColor:"lightblue",minimalRecordTime:2e3,keepButtonAliveInterval:0,isRecording:!1,llm_model:a.config.lepton_api.llm_models.wizardlm8x22b},f={elem:{currentInputElem:null,voiceButton:null},async init(){this.recorder=new a.Recorder,this.createButton(),fetch("https://apikey.suisuy.eu.org/get?apikeyname=fgptkey").then(async l=>{console.log(a.config.apiKey.flowgpt=await l.text())}),S.keepButtonAliveInterval=setInterval(()=>{document.getElementById("whisper_voice_button")||this.createButton()},2e3)},createButton(){if(document.getElementById("whisper_voice_button"))return;console.log("create button");let e=document.createElement("button");return this.elem.voiceButton=e,e.id=S.voice_button_id,e.innerText="◯",e.type="button",e.classList.add("speech-to-text-button"),e.style.top=window.innerHeight-100+"px",e.style.left="0",e.style.width="40px",e.style.height=e.style.width,e.style.fontSize="30px",e.style.padding="0",e.style.border="0px",e.style.color="blue",e.style.background="transparent",e.style.zIndex=1e6,e.style.position="fixed",e.style.borderRadius="50%",e.style.userSelect="none",e.style.touchAction="none",document.body.appendChild(e),a.dragElement(e,e),e.addEventListener("click",()=>{console.log("createButton():clicked")}),e.addEventListener("pointerdown",async t=>{t.preventDefault(),f.handler.startRecording(t)}),e.addEventListener("pointerup",()=>{console.log("createButton pointerup"),f.handler.stopRecording()}),a.addEventListenerForActualClick(e,t=>{let r=t==null?void 0:t.clientX,n=t==null?void 0:t.clientY;f.createMenu(r+50,n+50)}),a.addEventListenerForActualClick(document.body,t=>{f.recorder.isRecording||(t.target.tagName==="INPUT"?S.supportedInputTypeList.includes(t.target.type)&&a.moveElementNearMouse(e,t.target,!0,t):(t.target.tagName==="TEXTAREA"||a.isEditableElement(t.target)===!0)&&a.moveElementNearMouse(e,t.target,!0,t),console.log(t.target,a.isEditableElement(t.target)?"editable":"noneditable"))}),window.addEventListener("resize",()=>{let t=e.getBoundingClientRect();t.top>window.innerHeight-t.height&&(e.style.top=window.innerHeight-t.height+"px"),console.log("resize",t.top,window.innerHeight)}),e},createMenu(l,e,t="webai_input_menu"){const r=window.innerWidth,n=window.innerHeight;let o=document.getElementById(t);if(o){o.style.left=Math.min(l,r-o.offsetWidth*.5)+"px",o.style.top=Math.min(e,n-o.offsetHeight)-100+"px",o.style.zIndex="99999";return}o=document.createElement("div"),document.body.appendChild(o),o.id=t,o.style.zIndex="99999",o.style.position="fixed",o.style.backgroundColor="white",o.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.1)",o.style.borderRadius="4px",o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="flex-start",o.style.padding="10px",o.style.left=Math.min(l,r-o.offsetWidth)+"px",o.style.top=Math.min(e,n-o.offsetHeight)-100+"px",o.style.backgroundColor="white",o.style.boxShadow="0 2px 5px rgba(0, 0, 0, 0.1)",o.style.borderRadius="4px",o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="flex-start",o.style.padding="10px",o.style.opacity="0.7",a.disableSelect(o),o.style.maxHeight="60vh",o.style.overflowY="auto",o.style.cssText+=`
      scrollbar-width: thin; /* For Firefox */
      scrollbar-color: rgba(0, 0, 0, 0.3) transparent; /* For Chrome, Edge, and Safari */
    `,o.style.msOverflowStyle="none";function s(m,y){const w=document.createElement("button");return a.makeButtonFeedback(w),o.appendChild(w),w.style.cssText=`
        background-color: white;
        border: none;
        font-size: 14px;
        width: 80px;
        text-align: left;
        cursor: pointer;
        margin-bottom: 0;
        margin-top: 0;
        padding: 5px 10px;
        color: #333;
        transition: background-color 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        border-radius: 4px;
      `,w.textContent=m,w.addEventListener("pointerdown",v=>{v.preventDefault(),y&&y()}),w}const u=s("Remove Menu");u.addEventListener("pointerdown",()=>o.remove()),o.appendChild(u);const d=s("Close");d.addEventListener("pointerdown",()=>{confirm("remove the AI tool now?")&&(clearInterval(S.keepButtonAliveInterval),f.elem.voiceButton.remove(),o.remove())}),o.appendChild(d),s("TTS",()=>{a.tts(a.getSelectionText(),"de-DE-SeraphinaMultilingualNeural")});const p=s("Start");o.appendChild(p),p.addEventListener("pointerdown",()=>{f.elem.voiceButton.style.top="0px",f.elem.voiceButton.style.left=window.innerWidth*.8+"px",S.isRecording=!0,f.handler.startRecordingWithSilenceDetection()});let c=s("Copy");o.appendChild(c),c.addEventListener("pointerdown",m=>{m.preventDefault(),document.execCommand("copy"),a.showToast("Copied to clipboard")}),s("Cut",()=>{document.execCommand("copy"),document.execCommand("delete"),a.showToast("Cut to clipboard")});let C=s("Paste");o.appendChild(C),C.addEventListener("pointerdown",async m=>{m.preventDefault();try{const y=await navigator.clipboard.readText();a.writeText(document.activeElement,y),console.log("Clipboard text:",y)}catch(y){console.error("Clipboard access denied:",y)}});let T=s("Enter");o.appendChild(T),T.addEventListener("pointerdown",m=>{m.preventDefault(),document.execCommand("insertText",!1,`
`)}),s("Correct",()=>{f.handler.chat(`fix mistakes of the text, make it better,put anwser in codeblock:
 `)});let x=s("Ask");o.appendChild(x),x.addEventListener("pointerdown",m=>{m.preventDefault(),document.body.addEventListener("pointerup",()=>{S.isRecording||f.handler.stopRecording()},{once:!0}),f.handler.ask()}),o.style.left=Math.min(l,r-o.offsetWidth*.5)+"px",o.style.top=Math.min(e,n-o.offsetHeight)-100+"px",document.body.appendChild(o)},createMenuByGPT4(l,e){let t=document.getElementById("customMenu");if(t){t.style.left=l+"px",t.style.top=e+"px";return}let r=document.createElement("div");r.id="customMenu",r.style.position="fixed",r.style.left=l+"px",r.style.top=e+"px",r.style.backgroundColor="#f0f0f0",r.style.border="1px solid #ddd",r.style.padding="10px",r.style.borderRadius="5px",r.style.boxShadow="0 2px 6px rgba(0,0,0,0.2)",r.style.zIndex="1000",["Remove","Start","Stop"].forEach(function(o){let s=document.createElement("button");s.textContent=o,s.style.marginRight="5px",s.style.padding="5px 10px",s.style.border="none",s.style.borderRadius="3px",s.style.cursor="pointer",(o==="Start"||o==="Stop")&&(s.style.float="left"),o==="Remove"&&(s.onclick=function(){r.parentNode.removeChild(r)}),o==="Start"&&(s.onclick=function(){console.log("Start clicked")}),o==="Stop"&&(s.onclick=function(){console.log("Stop clicked")}),r.appendChild(s)}),document.body.appendChild(r)},handler:{async chat(l){let e=a.getSelectionText(),t=l+e;if(a.checkValidString(t)===!1){console.log("chat(): invalid userText:",t);return}a.displayMarkdown(t+` 
 please wait`),a.leptonSimpleComplete(t)},async ask(){if(S.isRecording){a.leptonSimpleComplete(a.getSelectionText());return}let l=Date.now(),e=await f.recorder.startRecording(f.elem.voiceButton);if(Date.now()-l<S.minimalRecordTime){a.showToast("time too short, this will not transcribe"),console.log("ask():",a.getSelectionText()),a.leptonSimpleComplete(a.getSelectionText());return}let t=await a.stt(e);t||(console.log("transcribe failed, try alternative way"),t=await j(e));let r=window.getSelection().toString(),n=a.checkValidString(r)?`"${r}" ${t.text}`:t.text;if(a.checkValidString(n)===!1){console.log("ask(): invalid userText:",n);return}n=n,a.displayMarkdown(n+" please wait"),a.leptonSimpleComplete(n)},async startRecording(l){let e=Date.now(),t=await f.recorder.startRecording(f.elem.voiceButton);if(Date.now()-e<S.minimalRecordTime){a.showToast("time too short, this will not transcribe");return}let r=await a.stt(t);r.text||(console.log("transcribe failed, try alternative way"),r=await j(t)),a.writeText(document.activeElement,r.text)},async startRecordingWithSilenceDetection(l){let e=Date.now(),t=await f.recorder.startRecordingWithSilenceDetection(f.elem.voiceButton,n=>{a.stt(n).then(o=>{o===!1?(console.log("transcribe failed, try alternative way"),j(n).then(s=>{a.writeText(document.activeElement,s)})):a.writeText(document.activeElement,o.text)})});if(Date.now()-e<S.minimalRecordTime){a.showToast("time too short, this will not transcribe");return}let r=await sendAudioToLeptonWhisperApi(t);r||(console.log("transcribe failed, try alternative way"),r=await j(t)),a.writeText(document.activeElement,r.text)},stopRecording(l=!0){S.isRecording=!1,l?setTimeout(()=>{console.log("safeStop"),f.recorder.stopRecording()},500):f.recorder.stopRecording()}}};f.init();async function j(l){const e=new WebSocket("wss://sanchit-gandhi-whisper-jax.hf.space/queue/join");return e.addEventListener("open",function(t){console.log("Connected to the server.")}),e.addEventListener("close",function(t){console.log("Disconnected from the server.")}),e.addEventListener("error",function(t){console.error("WebSocket error:",t)}),new Promise(async(t,r)=>{e.addEventListener("message",async function(n){console.log("Message from server:",n.data);function o(d,p){if(isNaN(d)||isNaN(p)||d>=p)throw new Error("Invalid min or max values. min must be less than max.");return Math.floor(Math.random()*(p-d+1))+d}const s=JSON.parse(n.data);let u="aaeegg"+o(900,1e3);if(s.msg==="send_hash")e.send(JSON.stringify({fn_index:0,session_hash:u}));else if(s.msg==="send_data"){const d="data:audio/wav;base64,"+await a.blobToBase64(l);e.send(JSON.stringify({data:[{data:d,name:"audio.wav"},"transcribe",!1],event_data:null,fn_index:0,session_hash:u}))}else if(s.msg==="estimation")console.log(`Estimated processing time: ${s.rank_eta} seconds`);else if(s.msg==="process_completed"){let d=s.output.data[0];console.log(d),t({text:d})}console.log(s)})})}console.log("end script");const b=document.createElement("div");b.id="esl-toolbar";b.style.position="fixed";b.style.top="0";b.style.left="0";b.style.width="100%";b.style.backgroundColor="lightgray";b.style.padding="10px";const A=document.createElement("button");A.id="ask-btn";A.textContent="Ask";const I=document.createElement("button");I.id="correct-btn";I.textContent="Correct";const _=document.createElement("button");_.id="translate-btn";_.textContent="Translate";const M=document.createElement("button");M.id="explain-btn";M.textContent="Explain";const N=document.createElement("button");N.id="define-btn";N.textContent="Define";b.appendChild(A);b.appendChild(I);b.appendChild(_);b.appendChild(M);b.appendChild(N);const W=document.createElement("div");W.id="content";W.contentEditable=!0;document.body.appendChild(b);document.body.appendChild(W);function P(){return window.getSelection().toString()}A.addEventListener("click",()=>{P(),devilentLIBS.leptonSimpleComplete(" "+window.getSelection().toString())});I.addEventListener("click",()=>{P(),devilentLIBS.leptonSimpleComplete(`fix mistakes of the text, make it better,put anwser in codeblock:
 `+window.getSelection().toString())});_.addEventListener("click",()=>{P(),devilentLIBS.leptonSimpleComplete(`translate to english,japanese,chinese:
 `+window.getSelection().toString())});M.addEventListener("click",()=>{P(),devilentLIBS.leptonSimpleComplete(`explain this for seconds language learner in simple english and japanese:
 `+window.getSelection().toString())});N.addEventListener("click",()=>{P(),devilentLIBS.leptonSimpleComplete(`define the word , first in simple english , and give some usage example:
 `+window.getSelection().toString())});b.style.position="fixed";b.style.top="0%";b.style.left="0";b.style.width="100%";b.style.backgroundColor="#f0f0f0";b.style.padding="10px";b.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)";const O={backgroundColor:"#4CAF50",border:"none",color:"white",padding:"10px 20px",textAlign:"center",textDecoration:"none",display:"inline-block",fontSize:"16px",margin:"4px 2px",cursor:"pointer",borderRadius:"5px"};for(const l of[A,I,_,M,N])Object.assign(l.style,O);
